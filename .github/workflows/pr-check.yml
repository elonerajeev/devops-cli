name: PR Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-title:
    name: Validate PR Title
    runs-on: ubuntu-latest
    steps:
      - name: Check PR title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          requireScope: false
          subjectPattern: ^[A-Z].+$
          subjectPatternError: |
            The subject "{subject}" doesn't match the pattern.
            - Start with a capital letter
            - Use imperative mood (e.g., "Add feature" not "Added feature")

  size-label:
    name: Label PR Size
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Label PR size
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });

            let additions = 0;
            let deletions = 0;
            files.forEach(file => {
              additions += file.additions;
              deletions += file.deletions;
            });

            const total = additions + deletions;
            let sizeLabel = 'size/XS';

            if (total > 1000) sizeLabel = 'size/XXL';
            else if (total > 500) sizeLabel = 'size/XL';
            else if (total > 250) sizeLabel = 'size/L';
            else if (total > 100) sizeLabel = 'size/M';
            else if (total > 30) sizeLabel = 'size/S';

            // Remove existing size labels
            const existingLabels = context.payload.pull_request.labels
              .filter(l => l.name.startsWith('size/'))
              .map(l => l.name);

            for (const label of existingLabels) {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                name: label
              }).catch(() => {});
            }

            // Add new size label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              labels: [sizeLabel]
            });

            console.log(`PR size: ${total} lines changed (${additions}+ / ${deletions}-) -> ${sizeLabel}`);

  changed-files:
    name: Detect Changed Components
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v42
        with:
          files_yaml: |
            commands:
              - 'devops_cli/commands/**'
            config:
              - 'devops_cli/config/**'
            docs:
              - '**/*.md'
              - 'docs/**'
            tests:
              - 'tests/**'
            ci:
              - '.github/**'
            scripts:
              - 'scripts/**'

      - name: Add labels
        uses: actions/github-script@v7
        with:
          script: |
            const labels = [];

            if ('${{ steps.changed-files.outputs.commands_any_changed }}' === 'true') {
              labels.push('commands');
            }
            if ('${{ steps.changed-files.outputs.config_any_changed }}' === 'true') {
              labels.push('config');
            }
            if ('${{ steps.changed-files.outputs.docs_any_changed }}' === 'true') {
              labels.push('documentation');
            }
            if ('${{ steps.changed-files.outputs.tests_any_changed }}' === 'true') {
              labels.push('tests');
            }
            if ('${{ steps.changed-files.outputs.ci_any_changed }}' === 'true') {
              labels.push('ci');
            }
            if ('${{ steps.changed-files.outputs.scripts_any_changed }}' === 'true') {
              labels.push('scripts');
            }

            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels: labels
              });
            }
